<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Battery: Battery Guidelines</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/batterycenter/battery" class="github-corner" title="View source on GitHub" target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="battery.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Battery
   &#160;<span id="projectnumber">v0.1.2</span>
   </div>
   <div id="projectbrief">Desktop application framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('guidelines.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Battery Guidelines </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>More about Windows</p>
<h1><a class="anchor" id="autotoc_md0"></a>
UTF-8 Everywhere</h1>
<p>Battery strictly follows <a href="http://utf8everywhere.org/">http://utf8everywhere.org/</a>. Read it thoroughly for an in-depth primer on Unicode.</p>
<p>The most important concepts are explained later again in the relevant sections, but here are the main takeaways from the manifesto:</p><ul>
<li>Every string and char* is always and everywhere considered to be UTF-8 encoded, the same is for any file on-disk and data from a network.</li>
<li>Do not use BOMs, since anything is considered to be UTF-8 anyways and it makes things such as file concatenation a nightmare.</li>
<li>All files you work with, especially the source code files must all be written as UTF-8</li>
<li>Always read and write files as binary, to store with LF line endings exclusively, even on Windows. CRLF has no place in modern, cross-platform computing. Windows deals with LF just fine these days.</li>
<li>Never use wide strings or UTF-16 anywhere except directly adjacent to system APIs or Library APIs.</li>
<li>There is no such thing as an ASCII-only string, every string can generally contain text in any language</li>
<li>A <em>character</em> can always consist of multiple bytes. Character literals are fine, but a <em>char</em> is not guaranteed to be sufficient for what you think of as a <em>character</em></li>
<li>The string length is always in terms of bytes or code units used in memory. User-perceived characters on screen cannot be mapped to individual code points (not even in UTF-32) and do not need to be</li>
<li>Even when you do low-level ASCII parsing, always consider every input and output to be UTF-8, and use Battery's utilities to strip non-ASCII characters if applicable. After that you are allowed to consider every byte as one <em>character</em>.</li>
<li>Never use ANSI-Win32 functions or the dependent Macro. Always use the Unicode variant explicitly (postfixed with W)</li>
</ul>
<p>&lt;details&gt;</p>
<p>Just as <a href="http://utf8everywhere.org/">http://utf8everywhere.org/</a> states, this is not a religious war against Windows or Microsoft. In fact, Battery was for a long time Windows-only and is still primarily developed for Windows.</p>
<p>Microsoft is not to be blamed for inventing the ANSI encoding, CRLF or choosing UTF-16, because they were one of the first ones to see the challenge back then. We just think it is time to move on and that nowadays it is time to ban ANSI encoding from modern software development.</p>
<p>&lt;/details&gt;</p>
<p>Battery provides you with many concepts that make your life easier: You do not have to stay inline with them, but if you do, you will have a much better time.</p>
<p>Many following concepts are explained in detail, why they cause headache and how you can use Battery to prevent that headache.</p>
<h2><a class="anchor" id="autotoc_md1"></a>
Unicode (UTF-8)</h2>
<p>Unicode support is a very broad topic and causes a lot of headache, especially on Windows. Due to the cross-platform nature of Battery, your code is supposed to run on any computer, be it Windows, Mac or Linux.</p>
<h3><a class="anchor" id="autotoc_md2"></a>
What is Unicode?</h3>
<p>First, you should be familiar with ASCII.</p>
<p>The problem with ASCII is that you cannot represent any character outside of the ASCII set. Greetings to all the germans out there, using programs going back to the Windows XP days, that crash as soon as you save a file containing an Umlaut like Ä, Ö, Ü :)</p>
<p>We do not want this, we want a modern, robust application. Unicode solves this problem, it is known as a Multibyte language and can therefore store basically any character in the world, by using more than one bytes per character.</p>
<p>There are multiple Unicode encodings out there, but we want to use <code>UTF-8</code>, as enforced by <a href="http://utf8everywhere.org">http://utf8everywhere.org</a>.</p>
<p>According to that, we want to use <code>UTF-8</code> encoded strings everywhere in our application. The most important thing to keep in mind is that a character is no longer a single byte. <code>char</code>s cannot be used anymore to store a character when we want to support Unicode. In this case a character is always a string with at least one byte, maybe more.</p>
<h3><a class="anchor" id="autotoc_md3"></a>
The Problem</h3>
<p>The problem comes with Windows, it is quite old and uses <code>UTF-16</code> for the WinAPI, as well as an ANSI version. See <a href="#WIN_LINUX_API">WinAPI / Linux API</a> for more information.</p>
<p>What is important for us here is that Windows does not use <code>UTF-8</code>, which is the reason why you must use Battery's tools for everthing. Battery takes great care for you that everything works out of the box, especially for things related to <code>UTF-8</code>.</p>
<p>This is not a problem on Linux and Unix-like systems, as they are built on top of <code>UTF-8</code>, all the way through. You could think of it as unifying the application logic to always use <code>UTF-8</code> on every system, and on Windows you only convert to <code>UTF-16</code> when talking to Windows directly.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Terminology</h2>
<p><a href="https://learnmoderncpp.com/2021/03/24/a-unicode-primer/">https://learnmoderncpp.com/2021/03/24/a-unicode-primer/</a></p>
<ul>
<li>ASCII is the most common character encoding, understood by everyone. It uses 7 bits only and one byte is one character. It is sometimes also called UTF-7.</li>
<li>Extended ASCII is not a real term and criticized as misleading, but is usually used to refer to Latin-1 or ISO-8859-1.</li>
<li>Latin-1 or ISO-8859-1 is a superset of ASCII and uses all 8 bits to provide more characters.</li>
<li>ANSI is not an encoding and has no official meaning, but is usually used to refer to windows-1252 enconding.</li>
<li>Windows-1252 is a Microsoft-specific superset of Latin-1 and provides even more characters in 8 bits.</li>
<li>All of these are very limited in terms of the number of possible characters. Unicode is a solution to this problem.</li>
<li>Unicode is a high-level definition of a character set. It assigns a 32-bit <em>Unicode codepoint</em> to every character of the <em>Unicode character set</em>. A Unicode string can be encoded by encoding <em>Unicode Codepoints</em> using <em>UTF-8</em>, <em>UTF-16</em> or <em>UTF-32</em>.</li>
<li>UTF-32 is the one-to-one encoding of <em>Unicode</em>, as every <em>codepoint</em> fits in 32 bits. Every character of a UTF-32 string uses 32 bits, always.</li>
<li>UTF-8 is the most common encoding for <em>Unicode</em>. Every character uses 1 to 4 bytes. Common ones use 1, less common ones use more. ASCII can always be interpreted as UTF-8 (it is backwards compatible). This is not the case for Latin-1 or Windows-1252.</li>
<li>UTF-16 follows the same rules as UTF-8, but every character uses one or two <em>16-bit code units</em>, in other words 2 or 4 bytes, depending on the <em>Unicode codepoint</em> being encoded.</li>
<li>Windows uses UTF-16 internally. In the area of Windows these are generally called <em>Wide Strings</em>. All the ANSI-functions (like CreateFileA) in the Windows API are just legacy wrappers around the UTF-16 variants. Do not use them.</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
Working with Unicode</h2>
<p>Following online tools can be used for working with Unicode. Be very cautious of the terminology used.</p>
<p>In the following websites, <em>unicode</em> is equivalent to <em>utf-8</em>. <br  />
 Be aware that you might have to set the base. If there is no dropdown menu for hexadecimal, set the base to 16 if your input is hexadecimal bytes. <br  />
</p>
<p>Convert a <em>Unicode string</em> to their corresponding <em>Unicode codepoints</em>: <a href="https://onlineunicodetools.com/convert-unicode-to-code-points">https://onlineunicodetools.com/convert-unicode-to-code-points</a> <br  />
</p>
<p>Convert a <em>Unicode string</em> to their <em>utf-8 encoded bytes</em>: <a href="https://onlineunicodetools.com/convert-unicode-to-utf8">https://onlineunicodetools.com/convert-unicode-to-utf8</a> <br  />
</p>
<p>Convert <em>utf-8 encoded bytes</em> to a <em>Unicode string</em> (set base to 16 for hexadecimal bytes): <a href="https://onlineutf8tools.com/convert-bytes-to-utf8">https://onlineutf8tools.com/convert-bytes-to-utf8</a></p>
<p>Many other converters are available on this site. Be careful of what exactly is encoded in which format. It's often not obvious.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
Source files</h2>
<p>To make <code>UTF-8</code> encoded string literals work, you must also save your source files as <code>UTF-8</code>. This is the default in most modern IDE's like Visual Studio Code or Jetbrains CLion.</p>
<p>You can usually select the file encoding in the bottom right corner, it should always be set to <code>UTF-8</code> for every file you work with. This is necessary so that your compiler interprets the source file correctly, otherwise the string literals means something different to the compiler. CMake additionally adds a flag to parse every source file as <code>UTF-8</code>.</p>
<p>Be aware that <em>u8 string literals</em> do not like byte-encoding. Never write <code>"\x23\x54\xfc"</code>-style strings, always use Unicode codepoints, like this: <code>"\uFC34"</code>.</p>
<h2><a class="anchor" id="WIN_LINUX_API"></a>
WinAPI / Linux API</h2>
<p>You are not encouraged to use the Windows API or the Linux API in any way. They are huge, unportable between OSes and you probably write a few thousand bugs when using these directly. Almost anything you want to do is probably implemented in the C++ Standard library or is available as a third-party cross-platform library. In such a case, use it.</p>
<p>In the very rare circumstances that you still have to use the WinAPI or the Linux API directly, because there is no other way, there are a few things to keep in mind.</p>
<h3><a class="anchor" id="autotoc_md7"></a>
WinAPI: Do not use ANSI functions!</h3>
<p>In the Win32 API, almost every function and data structure has two variants: e.g. <code>CreateWindowsA()</code> and <code>CreateWindowsW()</code>. The <code>...A()</code>-function is the ANSI function, forget that and never use it! There is no way it can support Unicode.</p>
<p>The <code>...W()</code>-functions on the other hand, are the WideString variants, or <code>UTF-16</code>. These are the ones you want to use. You have to convert your <code>UTF-8</code> string to <code>UTF-16</code> for the function call, and if you get something back, you convert it from <code>UTF-16</code> back to <code>UTF-8</code> immediately. See section <a href="#OsString">OsString</a>.</p>
<p>Just make sure to never use <code>std::wstring</code> or <code>wchar_t</code> manually and that all your logic stays in the <code>UTF-8</code> world. No ANSI, no ASCII, no <code>UTF-16</code>.</p>
<h3><a class="anchor" id="OsString"></a>
Use OsString whenever applicable</h3>
<p>For converting between <code>UTF-8</code> and <code>UTF-16</code>, there is a very handy class, called <code>Battery::OsString</code>. It is inspired by the <code>OsString</code> struct, supported natively in the <a href="https://doc.rust-lang.org/std/ffi/struct.OsString.html">Rust Programming Language</a>.</p>
<p>It is basically a string class, but it converts your string encoding automatically. Every <code>std::string</code> and <code>char*</code> is interpreted as a <code>UTF-8</code> string, while a <code>UTF-16</code> string is stored in an <code>std::wstring</code> or <code>wchar_t*</code>. A <code>wchar_t</code> is 16 bits wide on Windows. On Linux, an <code>std::wstring</code> and a <code>wchar_t*</code> are equivalent to a conventional string.</p>
<p>Here is an example how you could use the <code>OsString</code> class, while using the Win32 API:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;windows.h&gt;</span></div>
<div class="line"> </div>
<div class="line">std::string title = <span class="stringliteral">&quot;Important message&quot;</span>;</div>
<div class="line">std::string message = <span class="stringliteral">&quot;This is a UTF-8 message! Σ Φ μ π 乪 乫 乬&quot;</span>;</div>
<div class="line">MessageBoxW(<span class="keyword">nullptr</span>,                                        <span class="comment">// Notice how we use the ...W() variation</span></div>
<div class="line">            Battery::OsString(message).wstr().c_str(),</div>
<div class="line">            Battery::OsString(title).wstr().c_str(),</div>
<div class="line">            MB_ICONERROR);</div>
</div><!-- fragment --><p>What happens here is that we create an <code>OsString</code> instance with our string and it gets converted automatically. The call to <code>.wstr()</code> returns the string as a <code>std::wstring</code>, encoded as <code>UTF-16</code>. Finally, <code>.c_str()</code> gives us the raw C-pointer in the form of a <code>wchar_t*</code>, which is what the Windows API wants.</p>
<p>You do not have to write this of course, Battery offers you a cross-platform MessageBox function.</p>
<p>Be aware that the data below <code>c_str()</code> is only valid as long as the <code>std::wstring</code> object is alive.</p>
<p>And here is an example on how to do it the other way around: </p><div class="fragment"><div class="line">LPWSTR messageBuffer = <span class="keyword">nullptr</span>;                             <span class="comment">// C-sytle wide-character string (UTF-16)</span></div>
<div class="line"><span class="keywordtype">size_t</span> size = FormatMessageW(<span class="comment">/* ... */</span> (LPWSTR)&amp;messageBuffer <span class="comment">/* ... */</span>);</div>
<div class="line"> </div>
<div class="line">std::wstring message(messageBuffer, size);</div>
<div class="line">LocalFree(messageBuffer);</div>
<div class="line"> </div>
<div class="line">std::string str = OsString(message);</div>
</div><!-- fragment --><p>In this case, <code>FormatMessageW</code> takes a pointer to our pointer, allocates a buffer and writes the pointer to our pointer. Then we construct a <code>std::wstring</code> from the buffer, free the buffer and then convert our <code>wstring</code> to a <code>std::string</code>. Now it is <code>UTF-8</code> and we can happily use it whereever we want.</p>
<p>Just make sure that <code>wstring</code>, <code>wchar_t</code>, <code>LPWSTR</code> and so on are only used directly on the WinAPI and nowhere else.</p>
<h3><a class="anchor" id="autotoc_md8"></a>
Using high-level containers</h3>
<p>The Linux API doesn't have the <code>UTF-8</code> problems, it only gives you headache because it is so complicated and so easy to write bugs and memory leaks. Besides from the fact that it makes your code unportable, of course.</p>
<p>If you write code using any of these APIs, you should make sure to always take the time and read the documentation on the <a href="https://linux.die.net/man/">Linux man pages</a> or the <a href="https://learn.microsoft.com/en-us/windows/win32/api/">Microsoft Docs</a>. The best way is to search the internet, find out what functions to use, and then look out for the documentation of the needed functions on these two documentation pages.</p>
<p>The most important things to look out for in the function documentation are return values, error codes and exceptions, but most importantly: constraints on input parameters and if they allocate or free the memory you pass to it.</p>
<p>Once you know exactly how to deal with this function, you can apply high-level containers to make it safe. Most importantly <code>std::string</code> and <code>std::vector</code>. Many API calls need arrays of some sort and every kind of array can be implemented with an <code>std::vector</code>, instead of using <code>new</code> and <code>delete</code>. This will result in very safe code and the memory will be freed automatically. One example of using a high-level container directly with the API can be seen in <a href="#OsString">OsString</a>.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Keeping WinAPI / Linux API cross-platform</h3>
<p>The primary goal of Battery is to unify your code to compile on any platform. If you use the WinAPI or Linux API you prevent this of course, and it will only compile on one platform. Here is a guide on how you can make it cross-platform again, yourself.</p>
<p>Battery has a few <code>define</code>s which help you with this:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef B_OS_WINDOWS     </span><span class="comment">// If the platform is Windows</span></div>
<div class="line"><span class="preprocessor">#ifdef B_OS_LINUX       </span><span class="comment">// If the platform some flavour of Linux</span></div>
<div class="line"><span class="comment">//#ifdef B_OS_MACOS     // MacOS is not officially supported yet, but planned</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef B_ARCH_64          </span><span class="comment">// Platform is 64 bit</span></div>
<div class="line"><span class="preprocessor">#ifdef B_ARCH_32          </span><span class="comment">// Platform is 32 bit</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef B_COMPILER_MSVC    </span><span class="comment">// Compiler is Microsoft Visual C++ (Visual Studio)</span></div>
<div class="line"><span class="preprocessor">#ifdef B_COMPILER_GCC     </span><span class="comment">// Compiler is GNU Compiler Collection (or MinGW)</span></div>
<div class="line"><span class="preprocessor">#ifdef B_COMPILER_CLANG   </span><span class="comment">// Compiler is Clang</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef B_DEBUG            </span><span class="comment">// Debug build</span></div>
<div class="line"><span class="preprocessor">#ifdef B_RELEASE          </span><span class="comment">// Release build</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef B_PRODUCTION_MODE  </span><span class="comment">// Production mode</span></div>
</div><!-- fragment --><p>All of these blocks are guaranteed to be mutually exclusive.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> foo(<span class="keyword">const</span> std::string&amp; bar) {</div>
<div class="line"><span class="preprocessor">#if defined(B_OS_WINDOWS)</span></div>
<div class="line">    <span class="comment">// Do some Windows-specific work</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"><span class="preprocessor">#elif defined(B_OS_LINUX)</span></div>
<div class="line">    <span class="comment">// Do some Linux-specific work</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"><span class="comment">//#elif defined(B_OS_MACOS)             // MacOS is not supported yet, but planned</span></div>
<div class="line">    <span class="comment">// Do some Apple-specific work</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"><span class="preprocessor">#endif              </span><span class="comment">// No else needed, because the defines are mutually exclusive and guaranteed to be one of them</span></div>
<div class="line">    <span class="keywordflow">return</span> bar;</div>
<div class="line">}</div>
</div><!-- fragment --><p>This is how you write functions that use OS-specific features without sacrificing cross-platform availability.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Lockfiles</h1>
<p>Having multiple instances of your process is a great thing, but sometimes you need to make sure that only one instance can ever be running. This is what Lockfiles are good for. You might use them if you want to make sure that exactly one process can run and not a second, or if you have several processes that do critical work and one process doing critical work must block all others until it is finished.</p>
<p>You know this behaviour when you are on Linux, and call <code>apt</code> in two different terminals: The first terminal will run, and the second will give you an error like: "Cannot lock frontend, lockfile failed" or something similar. This is because the first process locked a file and the second cannot lock it again. It has to wait until the first one unlocks it again and then the second process can lock it and do critical work.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Different types</h2>
<p>Especially in more modern and more high-level programming languages, there are Fake-Lockfiles. This can also be found for C++ sometimes. Such Fake-Lockfiles simply create a file and the resource is 'locked' when the file exists. The resource is unlocked again when deleting the file. The problem with that is that the file remains when the process crashes or is stopped unexpectedly (PC shutdown). As a result the file remains and there is an infinite lock. You know this behaviour from tools where you must sometimes go into a folder, delete a file called <code>data.lock</code> for example, and then it works again.</p>
<p>Battery implements real Lockfiles: The difference is that the lock is not retrieved by creating a file, it is retrieved by opening the file in exclusive write mode. This means that in this case the file always remains and the first process opens it in exclusive write mode, which lock out anyone else. Nothing is written to the file, it is just kept open.</p>
<p>The advantage with this is that when the process stops or crashes, the lock is dropped immediately by the operating system. It is much closer to the process needing a resource: If a process does not exist anymore, it does not need the resource anymore.</p>
<p>The only disadvantage with this is that this operation might not be supported on networked locations. If you want a local Hard-Lock that is tied to a very specific process, use the hard lock option. If you want a Soft-Lock that can also work across network drives and is not tied to a specific process, use the soft lock option. Just be aware of the infinite lockup problem, when your process stops unexpectedly and then restarts.</p>
<h1><a class="anchor" id="autotoc_md12"></a>
OsString -&gt; Always terminates at '\0'</h1>
<pre class="fragment">auto path = std::filesystem::current_path();    // get path
std::filesystem::current_path(path);            // set path
</pre><p> add_custom_command() PRE_BUILD is Visual Studio only !!!!!!</p>
<p>WinAPI docs: WinAPI docs: Do not consider examples, they are outdated!</p>
<p><code>std::source_location::current()</code> instead of <b>FUNC</b> macros </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
